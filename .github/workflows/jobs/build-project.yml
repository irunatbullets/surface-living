name: Build Project
on:
  workflow_call:
    inputs:
      info-outputs:
        required: true
        type: object

jobs:
  build-project:
    name: Build Project
    runs-on: ubuntu-latest
    needs: info
    if: needs.info.outputs.pakku-lock_changed == 'true' || github.ref_name == 'main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Download Pakku
        run: |
          curl -L -o pakku.jar https://github.com/juraj-hrivnak/pakku/releases/latest/download/pakku.jar

      - name: Configure Pakku credentials
        run: |
          if [ -n "${{ secrets.CURSEFORGE_TOKEN }}" ]; then
            java -jar pakku.jar credentials set --cf-api-key="${{ secrets.CURSEFORGE_TOKEN }}"
          fi

      - name: Inject version + variables
        run: |
          # Update pakku.json with new version
          jq --arg v "${{ needs.info.outputs.project_version }}" '.version = $v' pakku.json > pakku.json.tmp
          mv pakku.json.tmp pakku.json

          # Replace placeholders in server override
          sed -i \
            -e "s/LOADER_VERSION/${{ needs.info.outputs.loader_version }}/g" \
            -e "s/LOADER_TYPE/${{ needs.info.outputs.loader_type }}/g" \
            -e "s/MINECRAFT_VERSION/${{ needs.info.outputs.mc_version }}/g" \
            .pakku/server-overrides/forge-auto-install.txt

      - name: Cache Pakku
        uses: actions/cache@v4
        with:
          path: build/.cache
          key: pakku-cache-${{ hashFiles('pakku-lock.json') }}
          restore-keys: pakku-cache-

      - name: Export modpack
        run: |
          java -jar pakku.jar fetch
          java -jar pakku.jar export

      - name: Prepare artifacts
        run: |
          FILE_SUFFIX=""
          if [ "${{ needs.info.outputs.make_release }}" != 'true' ]; then
            FILE_SUFFIX="-dev"
          fi

          mv build/modrinth/*.mrpack build/modrinth/${{ needs.info.outputs.project_file_name }}$FILE_SUFFIX-modrinth.mrpack
          mv build/serverpack/*.zip build/serverpack/${{ needs.info.outputs.project_file_name }}$FILE_SUFFIX-serverpack.zip

      - name: Upload Modrinth artifact
        uses: actions/upload-artifact@v4
        with:
          name: modrinth
          path: build/modrinth/*.mrpack

      - name: Upload Serverpack artifact
        uses: actions/upload-artifact@v4
        with:
          name: serverpack
          path: build/serverpack/*.zip
