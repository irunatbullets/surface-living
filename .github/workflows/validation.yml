name: Validation
run-name: "Validation #${{ github.run_number }}"

on:
  pull_request:
    branches: [main]

jobs:
  check-release-summary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check for release-triggering files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            trigger-release:
              - 'pakku.json'
              - 'pakku-lock.json'
              - '.pakku/**'
              - 'configs/**'
              - 'shaderpacks/**'

      - name: Validate RELEASES.md version
        if: steps.filter.outputs.trigger-release == 'true'
        run: |
          # Get the top header
          TOP_HEADER=$(grep -m1 '^## ' RELEASES.md)

          if [[ "$TOP_HEADER" == "## [Unreleased]" ]]; then
            echo "Unreleased summary found — release not ready." >&2
            exit 1
          fi

          # Extract version number from top header
          NEW_VERSION=$(echo "$TOP_HEADER" | sed -E 's/^## \[?([0-9]+\.[0-9]+\.[0-9]+)\]?.*/\1/')

          if [ -z "$NEW_VERSION" ]; then
            echo "No valid version found in RELEASES.md — release not ready." >&2
            exit 1
          fi

          # Compare against latest tag
          git fetch origin main --tags
          LATEST_TAG=$(git describe --tags --abbrev=0 origin/main 2>/dev/null || true)

          if [ "$NEW_VERSION" = "$LATEST_TAG" ]; then
            echo "ERROR: RELEASES.md has not been updated with a new version. Release cannot proceed." >&2
            exit 1
          fi

          echo "Release version ($NEW_VERSION) ready for release."

  check-overrides:
    runs-on: ubuntu-latest
    needs: check-release-summary
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Validate pakku.json overrides
        run: |
          # Read overrides array from pakku.json
          OVERRIDES=$(jq -r '.overrides[]' pakku.json)

          MISSING=0
          for path in $OVERRIDES; do
            if [ ! -e "$path" ]; then
              echo "ERROR: Override file '$path' does not exist."
              MISSING=$((MISSING + 1))
            fi
          done

          if [ "$MISSING" -ne 0 ]; then
            echo "One or more override files are missing. Please update pakku.json."
            exit 1
          fi

          echo "All override files exist."
          
